<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Diving into .NET source &#183;</title><meta name=description content="A quick look at some .NET source code"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.110.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Diving into .NET source"><meta property="og:description" content="A quick look at some .NET source code"><meta property="og:type" content="article"><meta property="og:url" content="/dotnet-is-open-source/"><link rel=stylesheet href=/dist/site.css><link rel=stylesheet href=/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous></head><body><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=/>Torbjörn Molin - Blog</a></h1><a class="button-square button-social hint--top" data-hint=Github aria-label=Github href=https://github.com/torbjornmolin rel=me><i class="fa fa-github-alt" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Email aria-label="Send an Email" href=mailto:konsult@torbjornmolin.se><i class="fa fa-envelope" aria-hidden=true></i></a></div><ul class=site-nav><li class=site-nav-item><a href=/>Blog</a></li><li class=site-nav-item><a href=/page/about/>About</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Diving into .NET source</h1><p class=post-description itemprop=description>A quick look at some .NET source code</p><p class="post-date post-line"><span>Published <time datetime=2022-08-23 itemprop=datePublished>Tue, Aug 23, 2022</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=# itemprop=url rel=author>Torbjörn Molin</a></span></span></p></header><div class="post-content clearfix" itemprop=articleBody><h2 id=once-upon-a-time>Once upon a time&mldr;</h2><p>Microsoft was, as many of us remember, not always a proponent of open source and free software. In the 1990s and 2000s the company did what it could to stop open source from gaining momentum and internal memos talked about embrace-extend-extinguish as a strategy that could be adopted.</p><p>The Microsoft of today is very different and some development tools that used to be closed source and very expensive are now free in one or two senses of the word. One product that is free in both senses of the word is .NET (core and 5 and 6, not framework) through the .NET Foundation.</p><p>A recurring theme for me as a developer is that I enjoy those moments when I get see how things that initially seem like magic actually work. One such thing is standard libraries, I imagine them to be written by ancient wizards who probably don&rsquo;t even have to type to get code to appear in their editor. Thanks to the .NET foundation we can have a look at the code written by these mysterious people.</p><h2 id=looking-at-the-source>Looking at the source</h2><p>Microsoft has <a href=https://dotnet.microsoft.com/en-us/platform/open-source>a page</a> introducing the .NET open source project, with a link to <a href="https://github.com/dotnet?WT.mc_id=dotnet-35129-website">GitHub</a> where it is hosted. Looking in GitHub we see that the project has 218 repositories, but if we&rsquo;re interested in the standard library, the runtime project is where we need to look.</p><p><img src=/dotnetplatformgithub.jpg alt="dotnet GitGub"></p><p>Let&rsquo;s have a look at something that we hopefully will understand, LINQs Where-method. If someone asked me to write it, I would probably come up with something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IEnumerable&lt;T&gt; NaiveWhere&lt;T&gt;(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#66d9ef>this</span> IEnumerable&lt;T&gt; source,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Func&lt;T, <span style=color:#66d9ef>bool</span>&gt; predicate
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>if</span> (source <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentException(nameof(source));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#66d9ef>if</span> (predicate <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentException(nameof(predicate));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> o <span style=color:#66d9ef>in</span> source)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#66d9ef>if</span> (predicate(o))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#66d9ef>yield</span> <span style=color:#66d9ef>return</span> o;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><p>This works and returns the expected result for a simple case using a couple of small tests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>var</span> colors = <span style=color:#66d9ef>new</span> List&lt;<span style=color:#66d9ef>string</span>&gt;() { <span style=color:#e6db74>&#34;red&#34;</span>, <span style=color:#e6db74>&#34;blue&#34;</span>, <span style=color:#e6db74>&#34;green&#34;</span> };
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#66d9ef>var</span> red = colors.NaiveWhere(c =&gt; c == <span style=color:#e6db74>&#34;red&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>System.Console.WriteLine(<span style=color:#e6db74>$&#34;Number of elements is 1: {red.Count() == 1}&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>System.Console.WriteLine(<span style=color:#e6db74>$&#34;Color is red: {red.FirstOrDefault() == &#34;</span>red<span style=color:#e6db74>&#34;}&#34;</span>);
</span></span></code></pre></div><p>Outputs:</p><pre tabindex=0><code>Number of elements is 1: True
Color is red: True
</code></pre><p>How does this compare to what is in the actual .NET runtime codebase, then? Well, to begin with, there is <code>Where.SpeedOpt.cs</code> and <code>Where.cs</code>, but let&rsquo;s look at <a href=https://github.com/dotnet/runtime/blob/main/src/libraries/System.Linq/src/System/Linq/Where.cs>the latter</a>.</p><p>This file is about 400 lines long and has two public methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IEnumerable&lt;TSource&gt; Where&lt;TSource&gt;(<span style=color:#66d9ef>this</span> IEnumerable&lt;TSource&gt; source, Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; predicate)
</span></span></code></pre></div><p>and</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IEnumerable&lt;TSource&gt; Where&lt;TSource&gt;(<span style=color:#66d9ef>this</span> IEnumerable&lt;TSource&gt; source, Func&lt;TSource, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>bool</span>&gt; predicate)
</span></span></code></pre></div><p>The second one is a version of the first one that allows us to use the index of the item in the predicate function. We can abuse it a bit and do:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>new</span>[] { <span style=color:#e6db74>&#34;red&#34;</span>, <span style=color:#e6db74>&#34;blue&#34;</span>, <span style=color:#e6db74>&#34;green&#34;</span> }
</span></span><span style=display:flex><span>.Where((data, index) =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    System.Console.WriteLine(<span style=color:#e6db74>$&#34;Color {index}: {data}&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}).ToList();
</span></span></code></pre></div><p>which will print</p><pre tabindex=0><code>Color 0: red
Color 1: blue
Color 2: green
</code></pre><p>But lets focus on the first method, the one with the predicate that only takes the object as input.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IEnumerable&lt;TSource&gt; Where&lt;TSource&gt;(<span style=color:#66d9ef>this</span> IEnumerable&lt;TSource&gt; source, Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; predicate)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#66d9ef>if</span> (source == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.source);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#66d9ef>if</span> (predicate == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.predicate);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#66d9ef>if</span> (source <span style=color:#66d9ef>is</span> Iterator&lt;TSource&gt; iterator)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#66d9ef>return</span> iterator.Where(predicate);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#66d9ef>if</span> (source <span style=color:#66d9ef>is</span> TSource[] array)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#66d9ef>return</span> array.Length == <span style=color:#ae81ff>0</span> ?
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            Empty&lt;TSource&gt;() :
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#66d9ef>new</span> WhereArrayIterator&lt;TSource&gt;(array, predicate);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#66d9ef>if</span> (source <span style=color:#66d9ef>is</span> List&lt;TSource&gt; list)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> WhereListIterator&lt;TSource&gt;(list, predicate);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> WhereEnumerableIterator&lt;TSource&gt;(source, predicate);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>}
</span></span></code></pre></div><p>This method has four cases, the one that would be taken for our test case with a <code>List&lt;string></code> is the third one that returns a <code>WhereListIterator</code> that is defined in the same file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// An iterator that filters each item of a &lt;see cref=&#34;List{TSource}&#34;/&gt;.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;typeparam name=&#34;TSource&#34;&gt;The type of the source list.&lt;/typeparam&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>partial</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WhereListIterator</span>&lt;TSource&gt; : Iterator&lt;TSource&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> List&lt;TSource&gt; _source;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; _predicate;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List&lt;TSource&gt;.Enumerator _enumerator;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> WhereListIterator(List&lt;TSource&gt; source, Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; predicate)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Debug.Assert(source != <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        Debug.Assert(predicate != <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        _source = source;
</span></span><span style=display:flex><span>        _predicate = predicate;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> Iterator&lt;TSource&gt; Clone() =&gt;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> WhereListIterator&lt;TSource&gt;(_source, _predicate);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>bool</span> MoveNext()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (_state)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>                _enumerator = _source.GetEnumerator();
</span></span><span style=display:flex><span>                _state = <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> (_enumerator.MoveNext())
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    TSource item = _enumerator.Current;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (_predicate(item))
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        _current = item;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Dispose();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> IEnumerable&lt;TResult&gt; Select&lt;TResult&gt;(Func&lt;TSource, TResult&gt; selector) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> WhereSelectListIterator&lt;TSource, TResult&gt;(_source, _predicate, selector);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> IEnumerable&lt;TSource&gt; Where(Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; predicate) =&gt;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> WhereListIterator&lt;TSource&gt;(_source, CombinePredicates(_predicate, predicate));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This class is an explicit implementation of an enumerator. It&rsquo;s not using the syntax sugar of <code>yield return</code> and <code>yield break</code> that our naive implementation did (read more <a href="https://devblogs.microsoft.com/oldnewthing/20080812-00/?p=21273">here</a>). Otherwise it is mostly the same. Every time <code>MoveNext</code> is called it advances until it finds an element that matches the predicate and sets <code>_current</code> to the found item.
When we reach the end of the enumerator we <code>Disose()</code>, <code>break</code> and <code>return false</code>.</p><p>One interesting feature is that the iterator returned overrides the Where-method so that it returns a new WhereListIterator with a new predicate that is obtained using <code>CombinePredicates</code>.
This is a simple little helper defined in <a href=https://github.com/dotnet/runtime/blob/57bfe474518ab5b7cfe6bf7424a79ce3af9d6657/src/libraries/System.Linq/src/System/Linq/Utilities.cs>Utilities.cs</a> that does exactly what it says on the box:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>/// A new predicate that will evaluate to &lt;c&gt;true&lt;/c&gt; only if both the first and</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// second predicates return true. If the first predicate returns &lt;c&gt;false&lt;/c&gt;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// the second predicate will not be run.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// &lt;/returns&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; CombinePredicates&lt;TSource&gt;(Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; predicate1, Func&lt;TSource, <span style=color:#66d9ef>bool</span>&gt; predicate2) =&gt;
</span></span><span style=display:flex><span>    x =&gt; predicate1(x) &amp;&amp; predicate2(x);
</span></span></code></pre></div><h2 id=summing-things-up>Summing things up</h2><p>Even if this was perhaps a trivial example, it&rsquo;s nice to be able to dive into some of the code that you&rsquo;d use every day as a .NET developer and understand how it&rsquo;s implemented. Even if we didn&rsquo;t go through all of the code paths or try to deep dive into why the various cases are needed, we got to see a bit of how the standard library code is structured.</p></div><footer class="post-footer clearfix"><div class=share><a class=icon-twitter href="https://twitter.com/share?text=Diving%20into%20.NET%20source&url=%2fdotnet-is-open-source%2f" onclick='return window.open(this.href,"twitter-share","width=550,height=235"),!1' aria-label="Share on Twitter"><i class="fa fa-twitter" aria-hidden=true></i></a></div></footer></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=/>Torbjörn Molin - Blog</a></h1><a class="button-square button-jump-top js-jump-top" href=# aria-label="Back to Top"><i class="fa fa-angle-up" aria-hidden=true></i></a></div><p class=footer-copyright><span>&copy; 2022 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p><p class=footer-copyright><span><a href=https://github.com/roryg/ghostwriter>Ghostwriter theme</a> By <a href=http://jollygoodthemes.com>JollyGoodThemes</a></span>
<span>/ <a href=https://github.com/jbub/ghostwriter>Ported</a> to Hugo By <a href=https://github.com/jbub>jbub</a></span></p></div></footer><script src=/js/jquery-1.11.3.min.js></script>
<script src=/js/jquery.fitvids.js></script>
<script src=/js/scripts.js></script></body></html>